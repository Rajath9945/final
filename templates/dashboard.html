<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Learning Intelligence Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Glassmorphism */
.glass {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(14px);
    border: 1px solid rgba(255,255,255,0.08);
}

/* Background motion */
.blob {
    position: absolute;
    width: 400px;
    height: 400px;
    border-radius: 50%;
    filter: blur(120px);
    opacity: 0.35;
    animation: move 18s infinite alternate ease-in-out;
}
.blob.one { background: #6366f1; top: -120px; left: -120px; }
.blob.two { background: #06b6d4; bottom: -150px; right: -150px; animation-delay: 4s; }
.blob.three { background: #22c55e; top: 40%; left: 55%; animation-delay: 8s; }

@keyframes move {
    from { transform: translate(0,0); }
    to { transform: translate(120px, -80px); }
}

/* Fade entrance */
.fade {
    animation: fadeIn 0.9s ease;
}
@keyframes fadeIn {
    from { opacity:0; transform: translateY(14px); }
    to { opacity:1; transform: translateY(0); }
}

/* Glow hover */
.glow:hover {
    box-shadow: 0 0 25px rgba(99,102,241,0.6);
}
</style>
</head>

<body class="relative bg-slate-950 text-white min-h-screen overflow-x-hidden">

<!-- Background blobs -->
<div class="blob one"></div>
<div class="blob two"></div>
<div class="blob three"></div>

<!-- HEADER -->
<div class="relative z-10 flex justify-between items-center p-8 border-b border-white/10">
    <div>
        <h1 class="text-4xl font-extrabold tracking-tight">
            Learning Intelligence Dashboard
        </h1>
        <p class="text-slate-300 mt-2">
            Session {{ session.session_id }} • AI-powered learning analytics
        </p>
    </div>
    <a href="/" class="px-6 py-3 rounded-xl glass hover:bg-indigo-600/30 transition glow">
        ← Sessions
    </a>
</div>

<div class="relative z-10 p-8 space-y-12 fade">

<!-- KPI CARDS -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="glass rounded-2xl p-6 hover:-translate-y-1 transition">
        <p class="text-slate-400">Duration</p>
        <p class="text-3xl font-bold">{{ session.duration_minutes }} min</p>
    </div>
    <div class="glass rounded-2xl p-6 hover:-translate-y-1 transition">
        <p class="text-slate-400">Frames</p>
        <p class="text-3xl font-bold">{{ session.total_frames }}</p>
    </div>
    <div class="glass rounded-2xl p-6 hover:-translate-y-1 transition">
        <p class="text-slate-400">Faces</p>
        <p class="text-3xl font-bold">{{ session.total_faces_analyzed }}</p>
    </div>
    <div class="glass rounded-2xl p-6 bg-gradient-to-br from-green-400/30 to-emerald-400/20">
        <p class="text-slate-300">Engagement</p>
        <p class="text-4xl font-bold">
            {{ (stats.engaged_ratio * 100) | round(1) }}%
        </p>
    </div>
</div>

<!-- AI INSIGHTS -->
<div class="glass rounded-2xl p-8">
    <h2 class="text-2xl font-semibold mb-4">AI Teaching Insights</h2>
    <ul class="space-y-3 text-slate-200">
        {% for s in suggestions %}
        <li class="flex gap-3">
            <span class="text-indigo-400">●</span>
            <span>{{ s }}</span>
        </li>
        {% endfor %}
    </ul>
</div>

<!-- CHARTS -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <div class="glass rounded-2xl p-6 glow">
        <h3 class="mb-3 font-semibold">Emotion Distribution</h3>
        <canvas id="barChart"></canvas>
    </div>
    <div class="glass rounded-2xl p-6 glow">
        <h3 class="mb-3 font-semibold">Emotion Share</h3>
        <canvas id="pieChart"></canvas>
    </div>
</div>

<!-- EMOTION EVIDENCE -->
<div class="glass rounded-2xl p-8">
    <h2 class="text-2xl font-semibold mb-6">Emotion Evidence</h2>

    <div class="flex flex-wrap gap-3 mb-6">
        {% for emo, imgs in images.items() %}
        <button onclick="toggleEmotion('{{ emo }}')"
            class="px-5 py-2 rounded-full glass hover:bg-indigo-500/30 transition">
            {{ emo.replace('_',' ') }} ({{ imgs|length }})
        </button>
        {% endfor %}
    </div>

    {% for emo, imgs in images.items() %}
    <div id="emotion-{{ emo }}" class="hidden">
        {% if imgs %}
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            {% for img in imgs %}
            <img src="{{ img }}" class="rounded-xl border border-white/10 hover:scale-105 transition">
            {% endfor %}
        </div>
        {% else %}
        <p class="text-slate-400">No images captured.</p>
        {% endif %}
    </div>
    {% endfor %}
</div>

<!-- COMPARE SECTION -->
<div class="relative overflow-hidden rounded-3xl border border-slate-800">
    <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-cyan-500 opacity-90"></div>

    <div class="relative p-10 text-black flex flex-col items-center text-center">
        <h2 class="text-3xl font-bold mb-2">Compare Learning Sessions</h2>
        <p class="opacity-90 max-w-xl">
            Visually analyze engagement and behaviour differences between sessions.
        </p>

        <form method="POST" action="/compare"
              class="flex flex-wrap justify-center items-center gap-4 mt-6">
            <input type="hidden" name="current_session" value="{{ session.session_id }}">

            <select name="compare_session"
                    class="p-4 rounded-xl font-semibold min-w-[260px]">
                {% for s in session_list %}
                {% if s.session_id != session.session_id %}
                <option value="{{ s.session_id }}">{{ s.session_id }}</option>
                {% endif %}
                {% endfor %}
            </select>

            <button type="submit"
                class="px-10 py-4 bg-black text-white rounded-2xl
                       font-bold hover:scale-110 transition glow">
                ⚡ Compare Now
            </button>
        </form>
    </div>
</div>

</div>

<!-- JS -->
<script>
function toggleEmotion(emo) {
    document.querySelectorAll('[id^="emotion-"]').forEach(div => {
        div.id === "emotion-" + emo
            ? div.classList.toggle("hidden")
            : div.classList.add("hidden");
    });
}

const labels = {{ labels | tojson }};
const values = {{ values | tojson }};

// BAR CHART – BUILD ON LOAD
new Chart(barChart, {
    type: "bar",
    data: {
        labels: labels,
        datasets: [{
            data: values,
            borderRadius: 8
        }]
    },
    options: {
        animation: {
            duration: 1800,
            easing: 'easeOutQuart',
            delay: (ctx) => ctx.dataIndex * 150
        },
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// DOUGHNUT CHART – DRAW EFFECT
new Chart(pieChart, {
    type: "doughnut",
    data: {
        labels: labels,
        datasets: [{
            data: values
        }]
    },
    options: {
        animation: {
            animateRotate: true,
            animateScale: true,
            duration: 2000,
            easing: 'easeOutCirc'
        },
        plugins: {
            legend: {
                position: 'bottom',
                labels: { color: '#e5e7eb' }
            }
        }
    }
});
</script>

</body>
</html>
